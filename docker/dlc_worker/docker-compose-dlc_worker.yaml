# docker-compose up --build
version: '2.4'
services:
  dlc_worker:
    build:
      # only necessary if rebuilding image
      context: .
      dockerfile: ./dlc_worker.Dockerfile
      args:
        - PY_VER
        - DEPLOY_KEY        
        - WORKER_BASE_HASH
        - REPO_OWNER
        - REPO_NAME
    image: registry.vathes.com/sciops/analysis-${REPO_NAME}:py${PY_VER}-debian-v${WORKFLOW_VERSION}
    runtime: nvidia
    environment:
      - CONTAINER_USER
      - DJ_HOST
      - DJ_USER
      - DJ_PASS
      - DATABASE_PREFIX
      - AWS_ACCESS_KEY
      - AWS_ACCESS_SECRET
      - IMAGING_ROOT_DATA_DIR=/home/${CONTAINER_USER}/inbox
      - IMAGING_PROCESSED_DATA_DIR=/home/${CONTAINER_USER}/outbox
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    volumes:
      - ${ROOT_DATA_DIR}:/home/${CONTAINER_USER}/inbox
      - ${PROCESSED_DATA_DIR}:/home/${CONTAINER_USER}/outbox
    scale: ${WORKER_COUNT:-1}
    command:
      - /bin/bash
      - -c
      - |
        run_workflow dlc_worker &
        tail -f /dev/null
